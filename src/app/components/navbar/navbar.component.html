<nav class="navbar px-4 shadow-sm">
  <div class="container-fluid d-flex align-items-center justify-content-between">

    <div class="d-flex align-items-center gap-3">
      <button class="btn-toggle ripple border-0 bg-transparent" (click)="toggleSidebar.emit()" title="Menu">
        <i class="bi bi-list fs-3 text-secondary"></i>
      </button>

      <div class="d-none d-md-block ms-2 border-start ps-3">
        <h5 class="mb-0 fw-bold nav-title text-dark cursor-pointer" routerLink="/dashboard">
          Tableau de Bord
        </h5>
        <span class="nav-welcome small text-primary fw-medium" *ngIf="currentUser">
          <i class="bi bi-person-check me-1"></i>
          Session : {{ currentUser.nom || currentUser.username }}
        </span>
      </div>
    </div>

    <div class="d-flex align-items-center gap-2 gap-md-4">

      <div class="notification-group position-relative">
        <button class="notif-btn ripple border-0 bg-transparent position-relative p-2"
                [class.bell-shake]="notifications.length > 0"
                (click)="toggleNotifMenu()">
          <i class="bi fs-5 text-secondary"
             [ngClass]="notifications.length > 0 ? 'bi-bell-fill text-warning' : 'bi-bell'"></i>

          <span *ngIf="notifications.length > 0"
                class="badge-count animate__animated animate__bounceIn">
            {{ notifications.length > 9 ? '9+' : notifications.length }}
          </span>
        </button>

        <div class="nav-dropdown notif-dropdown shadow-lg animate__animated animate__fadeIn border-0" *ngIf="notifMenuOpen">
          <div class="p-3 border-bottom d-flex justify-content-between align-items-center bg-light">
            <h6 class="mb-0 fw-bold text-dark">Alertes Stock</h6>
            <button *ngIf="notifications.length > 0" (click)="toutMarquerLu()" class="btn-clear text-primary border-0 bg-transparent small fw-bold">
              Tout marquer lu
            </button>
          </div>

          <div class="notif-list-container custom-scrollbar">
            <div *ngIf="notifications.length === 0" class="p-5 text-center">
              <div class="empty-notif-icon mb-3">
                <i class="bi bi-shield-check fs-1 text-success opacity-50"></i>
              </div>
              <p class="small text-muted mb-0">Tout est sous contr√¥le !</p>
            </div>

            <div *ngFor="let n of notifications"
                 class="notif-item p-3 border-bottom d-flex gap-3 align-items-start transition-all"
                 [class.unread-bg]="!n.lu">
              <div class="notif-icon-circle rounded-circle p-2 shadow-sm"
                   [ngClass]="n.type === 'ALERTE' ? 'bg-danger-subtle text-danger' : 'bg-info-subtle text-info'">
                <i class="bi" [ngClass]="n.type === 'ALERTE' ? 'bi-exclamation-triangle-fill' : 'bi-info-circle-fill'"></i>
              </div>

              <div class="flex-grow-1 overflow-hidden">
                <div class="d-flex justify-content-between align-items-center mb-1">
                  <span class="notif-title fw-bold text-dark small text-truncate">{{ n.titre }}</span>
                  <button (click)="marquerLue(n.id, $event)" class="btn-mark-read border-0 bg-transparent p-0 text-muted" title="Marquer comme lu">
                    <i class="bi bi-check2"></i>
                  </button>
                </div>
                <p class="notif-msg mb-1 text-muted small lh-sm">{{ n.message }}</p>
                <div class="d-flex align-items-center gap-2">
                  <i class="bi bi-clock-history smaller text-muted"></i>
                  <small class="notif-date text-muted smaller">{{ n.dateCreation | date:'HH:mm' }}</small>
                </div>
              </div>
            </div>
          </div>

          <div class="p-2 text-center border-top bg-light-soft">
            <a class="btn btn-sm btn-link text-decoration-none text-primary w-100 fw-bold py-2"
               routerLink="/notifications"
               (click)="notifMenuOpen = false">
              <i class="bi bi-eye me-2"></i>Voir tout l'historique
            </a>
          </div>
        </div>
      </div>

      <div class="profile-group position-relative" *ngIf="currentUser">
        <button class="profile-btn d-flex align-items-center gap-2 gap-md-3 ripple border-0 bg-transparent p-1 px-md-2 rounded-pill"
                (click)="toggleProfileMenu()">
          <div class="profile-text d-none d-sm-block text-end">
            <div class="user-name fw-bold text-dark lh-1 mb-1">{{ currentUser.nom }}</div>
            <span class="user-role badge rounded-pill bg-primary-subtle text-primary border-primary-subtle px-2">
              {{ currentUser.role }}
            </span>
          </div>
          <div class="avatar-circle-wrapper">
            <div class="avatar-circle bg-primary text-white shadow-sm fw-bold">
              {{ initiales }}
            </div>
          </div>
          <i class="bi bi-chevron-down nav-chevron text-muted d-none d-md-block" [class.rotated]="profileMenuOpen"></i>
        </button>
      </div>

    </div>
  </div>
</nav>
