<div class="header-section mb-5">
  <div class="d-flex align-items-center justify-content-between">
    <div>
      <h2 class="fw-bold text-dark mb-1">
        <i class="bi bi-stars text-primary me-2"></i>Intelligence Prédictive
      </h2>
      <p class="text-muted mb-0">Analyse algorithmique des flux et prévisions de rupture.</p>
    </div>
    <div class="badge bg-primary-subtle text-primary p-2 px-3 rounded-pill border border-primary-subtle">
      Moteur IA Actif
    </div>
  </div>
</div>

<div class="row g-4" *ngIf="!chargement; else loader">
  <div class="col-xl-4 col-md-6" *ngFor="let p of predictions">
    <div class="card border-0 shadow-lg h-100 position-relative overflow-hidden transition-hover" style="border-radius: 28px;">

      <div class="position-relative" style="height: 160px;">
        <img [src]="p.imageUrl || 'https://placehold.co/400x200?text=Produit'"
             class="w-100 h-100" style="object-fit: cover;" [alt]="p.nomProduit">

        <div class="position-absolute bottom-0 start-0 w-100 p-3"
             style="background: linear-gradient(transparent, rgba(0,0,0,0.7));">
          <h5 class="fw-bold text-white mb-0 text-truncate">{{ p.nomProduit }}</h5>
        </div>

        <div class="position-absolute top-0 end-0 p-3">
          <span [ngClass]="{
            'bg-danger': p.tendance === 'HAUSSE',
            'bg-success': p.tendance === 'BAISSE',
            'bg-info': p.tendance === 'STABLE'
          }" class="badge rounded-pill shadow px-3 py-2 border border-white border-2">
            {{ p.tendance }} <i class="bi" [ngClass]="p.tendance === 'HAUSSE' ? 'bi-graph-up-arrow' : 'bi-graph-down-arrow'"></i>
          </span>
        </div>
      </div>

      <div class="card-body p-4">
        <div class="d-flex align-items-center mb-4 bg-light rounded-4 p-2 border border-light-subtle">
          <div class="prediction-circle me-3 d-flex flex-column align-items-center justify-content-center shadow-sm"
               [ngClass]="p.joursRestants < 5 ? 'danger' : 'safe'">
            <span class="h3 fw-black mb-0">{{ p.joursRestants }}</span>
            <span class="small fw-bold text-uppercase" style="font-size: 0.55rem;">Jours</span>
          </div>
          <div>
            <div class="small text-muted">Estimation de rupture</div>
            <div class="fw-bold text-dark">{{ p.dateRupturePrevue | date:'dd MMM yyyy' }}</div>
          </div>
        </div>

        <div class="row g-2 mb-4">
          <div class="col-6">
            <div class="p-3 rounded-4 border border-danger-subtle bg-danger-subtle bg-opacity-10 h-100">
              <div class="small text-muted mb-1">Impact Risque</div>
              <div class="fw-bold text-danger">{{ p.impactFinancier | number:'1.0-0' }} <small>CFA</small></div>
            </div>
          </div>
          <div class="col-6">
            <div class="p-3 rounded-4 border border-primary-subtle bg-primary-subtle bg-opacity-10 h-100">
              <div class="small text-muted mb-1">Commande IA</div>
              <div class="fw-bold text-primary">+ {{ p.quantiteSuggeree }} u.</div>
            </div>
          </div>
        </div>

        <div class="mb-3">
          <div class="d-flex justify-content-between mb-1">
            <span class="small text-muted">Indice de confiance</span>
            <span class="small fw-bold">{{ p.confianceIA * 100 | number:'1.0-0' }}%</span>
          </div>
          <div class="progress shadow-sm" style="height: 7px; border-radius: 10px; background-color: #eee;">
            <div class="progress-bar progress-bar-striped progress-bar-animated"
                 [style.width.%]="p.confianceIA * 100"
                 [style.background-color]="getConfianceColor(p.confianceIA)"></div>
          </div>
        </div>

        <div class="p-3 bg-light rounded-4 border-0 position-relative">
          <i class="bi bi-quote text-primary opacity-25 position-absolute top-0 start-0 m-2 h4"></i>
          <p class="small mb-0 fst-italic text-dark ps-3">
            {{ p.message }}
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<ng-template #loader>
  <div class="text-center py-5">
    <div class="spinner-grow text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
    <p class="text-muted mt-3 fw-medium">L'IA parcourt vos entrepôts numériques...</p>
  </div>
</ng-template>
